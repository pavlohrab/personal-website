---
import { getCollection } from 'astro:content';
// Component Imports
import CallToAction from '../components/CallToAction.astro';
// Page section components
import ContactCTA from '../components/ContactCTA.astro';
import Grid from '../components/Grid.astro';
import Hero from '../components/Hero.astro';
import Icon from '../components/Icon.astro';
import Pill from '../components/Pill.astro';
import ProjectCard from '../components/cards/ProjectCard.astro';
import Skills from '../components/Skills.astro';
// Layout import â€” provides basic page elements: <head>, <nav>, <footer> etc.
import BaseLayout from '../layouts/BaseLayout.astro';

// Content Fetching
// Featured projects (show 3-4 featured projects)
const featuredProjects = (await getCollection('projects'))
	.filter(p => p.data.featured === true && !p.data.draft)
	.sort((a, b) => a.data.order - b.data.order)
	.slice(0, 4);

// Featured publications (show publications marked as featured)
const featuredPublications = (await getCollection('publications'))
	.filter(p => p.data.featured === true && !p.data.draft)
	.sort((a, b) => b.data.publishedDate.valueOf() - a.data.publishedDate.valueOf())
	.slice(0, 3);

// Latest news (show 3 most recent)
const latestNews = (await getCollection('news'))
	.filter(n => !n.data.draft)
	.sort((a, b) => b.data.publishedDate.valueOf() - a.data.publishedDate.valueOf())
	.slice(0, 3);
---

<BaseLayout>
	<div class="stack gap-20 lg:gap-48">
		<div class="wrapper stack gap-8 lg:gap-20">
			<header class="hero">
				<Hero
					title="Pavlo Hrab"
					tagline="(Marine) Bioinformatics Researcher | PhD Candidate"
					align="start"
				>
					<div class="intro-text">
						<p>
							Bioinformatician studying microbial communities by combining molecular lab and computational multi-omics approaches.<span class="mobile-hide"> Currently focused on Acidobacteriota - a biosynthetically rich yet understudied bacterial phylum. I integrate metagenomics, metatranscriptomics, and cultivation to discover novel natural products and understand how bacteria adapt to their hosts.</span>
						</p>
					</div>
					<div class="hero-cta">
						<a href={`${import.meta.env.BASE_URL}cv/`} class="hero-button primary">View CV</a>
						<a href={`${import.meta.env.BASE_URL}contact/`} class="hero-button primary">Contact Me</a>
					</div>
				</Hero>

				<img src={`${import.meta.env.BASE_URL}pavlo-hero.jpg`} alt="Pavlo Hrab" class="hero-image" />
			</header>

			<!-- Research Stats -->
			<section class="stats-section">
				<div class="stats-grid">
					<div class="stat-card">
						<div class="stat-number" data-target="3">0</div>
						<div class="stat-label">Publications</div>
					</div>
					<div class="stat-card">
						<div class="stat-number" data-target="16">0</div>
						<div class="stat-label">Conference Presentations</div>
					</div>
					<div class="stat-card">
						<div class="stat-number" data-target="2">0</div>
						<div class="stat-label">Open-source Tools</div>
					</div>
					<div class="stat-card">
						<div class="stat-number" data-target="10000">0</div>
						<div class="stat-label">Genomes Analyzed</div>
					</div>
				</div>
			</section>

			<section class="research-interests">
				<h2 class="section-title">Research Focus</h2>
				<div class="interests-grid">
					<div class="interest-card">
						<h3>(Marine) Microbiome Genomics</h3>
						<p>Investigating microbial communities in marine sponges using metagenomics and genomics to uncover hidden diversity, with focus on understudied bacterial phyla like Acidobacteriota</p>
					</div>
					<div class="interest-card">
						<h3>Natural Product Discovery</h3>
						<p>Mining novel biosynthetic gene clusters from undercharacterized bacterial lineages using unconventional computational approaches and large-scale genomic datasets</p>
					</div>
					<div class="interest-card">
						<h3>Comparative Genomics</h3>
						<p>Reconstructing evolutionary relationships and identifying genomic adaptations across bacterial lineages using phylogenomics and comparative analyses</p>
					</div>
					<div class="interest-card">
						<h3>Host-Microbe Interactions</h3>
						<p>Understanding what drives bacteria to associate with marine sponge hosts, distinguishing ecological adaptation from shared ancestry</p>
					</div>
				</div>
			</section>
		</div>

		<main class="wrapper stack gap-20 lg:gap-48">
			<!-- Featured Projects Section -->
			{featuredProjects.length > 0 && (
				<section class="section with-background with-cta">
					<header class="section-header stack gap-2 lg:gap-4">
						<h3>Featured Projects</h3>
						<p>Current research projects and ongoing work</p>
					</header>

					<div class="featured-projects">
						{featuredProjects.map(project => (
							<div class="scroll-reveal">
								<ProjectCard
									title={project.data.title}
									status={project.data.status}
									meta={project.data.meta}
									description={project.data.description}
									tags={project.data.tags}
									links={project.data.links}
									href={`/projects/${project.id}/`}
									featured={true}
								/>
							</div>
						))}
					</div>

					<div class="cta">
						<CallToAction href={`${import.meta.env.BASE_URL}projects/`}>
							View All Projects
							<Icon icon="arrow-right" size="1.2em" />
						</CallToAction>
					</div>
				</section>
			)}

			<!-- Publications Section -->
			<section class="section with-background with-cta">
				<header class="section-header stack gap-2 lg:gap-4">
					<h3>Recent Publications</h3>
					<p>Selected recent research papers and conference proceedings.</p>
				</header>

				<div class="recent-publications">
					{featuredPublications.map(pub => (
						<article class="pub-preview">
							<h4>{pub.data.title}</h4>
							<p class="pub-authors" set:html={pub.data.authors} />
							<p class="pub-venue"><em>{pub.data.venue}</em>, {pub.data.year}</p>
						</article>
					))}
				</div>

				<div class="cta">
					<CallToAction href={`${import.meta.env.BASE_URL}publications/`}>
						View All Publications
						<Icon icon="arrow-right" size="1.2em" />
					</CallToAction>
				</div>
			</section>

			<!-- News Section -->
			<section class="section with-background bg-variant with-cta">
				<header class="section-header stack gap-2 lg:gap-4">
					<h3>Latest News</h3>
					<p>
						Recent updates, talks, and academic activities.
					</p>
				</header>

				<div class="news-list">
					{latestNews.map(news => {
						const hasContent = news.body && news.body.trim().length > 0;

						return hasContent ? (
							<a href={`/news/${news.id}/`} class="news-item-link">
								<div class="news-item">
									<span class="news-date">{news.data.date}</span>
									<p>{news.data.description}</p>
								</div>
							</a>
						) : (
							<div class="news-item">
								<span class="news-date">{news.data.date}</span>
								<p>{news.data.description}</p>
							</div>
						);
					})}
				</div>

				<div class="cta">
					<CallToAction href={`${import.meta.env.BASE_URL}news/`}>
						View All News
						<Icon icon="arrow-right" size="1.2em" />
					</CallToAction>
				</div>
			</section>
		</main>
	</div>
</BaseLayout>

<style>
	.hero {
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: 2rem;
		padding-block: 2rem;
	}

	@media (max-width: 50em) {
		.hero {
			gap: 1.5rem;
			padding-block: 0.25rem;
		}
	}

	/* On mobile: show image first (order: -1), then text (order: 1) */
	.hero > :first-child {
		order: 1;
	}

	.hero-image {
		order: -1;
	}

	.intro-text {
		margin-top: 1rem;
		max-width: 50ch;
	}

	.intro-text p {
		font-size: var(--text-lg);
		color: var(--gray-300);
		line-height: 1.6;
	}

	.hero-cta {
		display: flex;
		gap: 1rem;
		margin-top: 1.5rem;
		flex-wrap: wrap;
	}

	.hero-button {
		display: inline-block;
		padding: 0.75rem 2rem;
		border-radius: 0;
		font-size: var(--text-base);
		font-weight: 600;
		text-decoration: none;
		transition: all var(--theme-transition);
		border: 1px solid var(--accent-regular);
	}

	.hero-button.primary {
		background: var(--accent-regular);
		color: var(--gray-999);
	}

	.hero-button.primary:hover {
		background: var(--accent-dark);
		opacity: 0.9;
	}

	.hero-button.secondary {
		background: transparent;
		color: var(--accent-regular);
		border: 1px solid var(--accent-regular);
	}

	.hero-button.secondary:hover {
		background: var(--accent-regular);
		color: var(--gray-999);
	}

	.hero-image {
		width: 100%;
		max-width: 500px;
		aspect-ratio: 3 / 4;
		object-fit: cover;
		border-radius: 1rem;
		box-shadow: var(--shadow-md);
		position: relative;
		z-index: 1;
	}

	/* Stats Section */
	.stats-section {
		padding-block: 1rem;
	}

	@media (max-width: 50em) {
		.stats-section {
			padding-block: 0.5rem;
		}
	}

	.stats-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
		gap: 1.5rem;
	}

	.stat-card {
		padding: 2rem 1.5rem;
		background: var(--gray-999);
		border-radius: 0.5rem;
		text-align: center;
		border-top: 3px solid var(--accent-regular);
		box-shadow: var(--shadow-sm);
	}

	.stat-number {
		font-size: var(--text-3xl);
		font-weight: 600;
		color: var(--gray-0);
		font-family: var(--font-brand);
		margin-bottom: 0.25rem;
	}

	.stat-label {
		font-size: var(--text-sm);
		color: var(--gray-300);
		text-transform: uppercase;
		letter-spacing: 0.05em;
		line-height: 1.3;
	}

	.research-interests {
		padding-block: 2rem;
	}

	.section-title {
		font-size: var(--text-2xl);
		color: var(--gray-0);
		margin-bottom: 1.5rem;
		text-align: center;
	}

	.interests-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
		gap: 1.5rem;
		margin-top: 2rem;
	}

	.interest-card {
		padding: 1.5rem;
		background: var(--gray-999);
		border-radius: 0.75rem;
		border-left: 3px solid var(--accent-regular);
		box-shadow: var(--shadow-sm);
	}

	.interest-card h3 {
		font-size: var(--text-lg);
		color: var(--gray-0);
		margin: 0 0 0.5rem;
	}

	.interest-card p {
		font-size: var(--text-base);
		color: var(--gray-300);
		margin: 0;
	}

	@media (min-width: 50em) {
		.hero {
			display: grid;
			grid-template-columns: 1fr 300px;
			padding-inline: 2.5rem;
			gap: 3.75rem;
			align-items: start;
		}

		/* Reset order on desktop - text left, image right */
		.hero > :first-child {
			order: 0;
		}

		.hero-image {
			max-width: 100%;
			order: 0;
		}
	}

	/* ====================================================== */

	.section {
		display: grid;
		gap: 2rem;
	}

	.with-background {
		position: relative;
	}

	.with-background::before {
		--hero-bg: var(--bg-image-subtle-2);

		content: '';
		position: absolute;
		pointer-events: none;
		left: 50%;
		width: 100vw;
		aspect-ratio: calc(2.25 / var(--bg-scale));
		top: 0;
		transform: translateY(-75%) translateX(-50%);
		background:
			url('/assets/backgrounds/noise.png') top center/220px repeat,
			var(--hero-bg) center center / var(--bg-gradient-size) no-repeat,
			var(--gray-999);
		background-blend-mode: overlay, normal, normal, normal;
		mix-blend-mode: var(--bg-blend-mode);
		z-index: -1;
	}

	.with-background.bg-variant::before {
		--hero-bg: var(--bg-image-subtle-1);
	}

	.section-header {
		justify-self: center;
		text-align: center;
		max-width: 50ch;
		font-size: var(--text-md);
		color: var(--gray-300);
	}

	.section-header h3 {
		font-size: var(--text-2xl);
	}

	@media (min-width: 50em) {
		.section {
			grid-template-columns: repeat(4, 1fr);
			grid-template-areas: 'header header header header' 'gallery gallery gallery gallery';
			gap: 5rem;
		}

		.section.with-cta {
			grid-template-areas: 'header header header cta' 'gallery gallery gallery gallery';
		}

		.section-header {
			grid-area: header;
			font-size: var(--text-lg);
		}

		.section-header h3 {
			font-size: var(--text-4xl);
		}

		.with-cta .section-header {
			justify-self: flex-start;
			text-align: left;
		}

		.gallery {
			grid-area: gallery;
		}

		.cta {
			grid-area: cta;
		}
	}

	/* ====================================================== */

	.recent-publications {
		display: grid;
		gap: 1.5rem;
		padding: 2rem 0;
		grid-column: 1 / -1;
		max-width: 60rem;
		margin-inline: auto;
		width: 100%;
	}

	.pub-preview {
		padding: 1.5rem;
		background: var(--gray-999);
		border-left: 3px solid var(--accent-regular);
		border-radius: 0.5rem;
		box-shadow: var(--shadow-sm);
		transition: all var(--theme-transition);
	}

	.pub-preview:hover {
		transform: translateX(4px);
		box-shadow: var(--shadow-md);
	}

	.pub-preview h4 {
		font-size: var(--text-lg);
		color: var(--gray-0);
		margin: 0 0 0.5rem;
	}

	.pub-authors {
		font-size: var(--text-base);
		color: var(--gray-300);
		margin: 0 0 0.25rem;
	}

	.pub-authors :global(strong) {
		color: var(--gray-0);
		font-weight: 600;
	}

	.pub-venue {
		font-size: var(--text-base);
		color: var(--gray-400);
		margin: 0;
	}

	.pub-venue em {
		color: var(--accent-regular);
		font-style: normal;
	}

	.news-list {
		display: grid;
		gap: 1rem;
		padding: 2rem 0;
		grid-column: 1 / -1;
		max-width: 60rem;
		margin-inline: auto;
		width: 100%;
	}

	.news-item-link {
		text-decoration: none;
		display: block;
	}

	.news-item {
		padding: 1rem 1.5rem;
		background: var(--gray-999);
		border-radius: 0.5rem;
		border-left: 3px solid var(--accent-light);
		box-shadow: var(--shadow-sm);
		transition: all var(--theme-transition);
	}

	.news-item-link .news-item {
		cursor: pointer;
	}

	.news-item:hover {
		transform: translateX(4px);
		box-shadow: var(--shadow-md);
	}

	.news-date {
		font-size: var(--text-sm);
		color: var(--accent-regular);
		font-weight: 600;
		display: block;
		margin-bottom: 0.25rem;
	}

	.news-item p {
		font-size: var(--text-base);
		color: var(--gray-200);
		margin: 0;
	}

	.featured-projects {
		display: grid;
		gap: 1.5rem;
		padding: 2rem 0;
		grid-column: 1 / -1;
		max-width: 70rem;
		margin-inline: auto;
		width: 100%;
		grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
	}

	/* Project card wrapper for scroll reveal */
	.featured-projects .scroll-reveal {
		height: 100%;
		display: flex;
	}

	.featured-projects .scroll-reveal > * {
		flex: 1;
	}

	@media (max-width: 50em) {
		/* Hide extra intro text on mobile */
		.mobile-hide {
			display: none;
		}

		/* Research Focus: 2x2 grid on mobile, titles only */
		.interests-grid {
			grid-template-columns: repeat(2, 1fr);
			gap: 0.75rem;
		}

		.interest-card {
			padding: 0.75rem;
		}

		.interest-card h3 {
			font-size: 1.05rem;
			font-weight: 500;
			line-height: 1.3;
			word-break: break-word;
		}

		.interest-card p {
			display: none;
		}

		/* Projects: Show only first project on mobile */
		.featured-projects .scroll-reveal:nth-child(n+2) {
			display: none;
		}

		/* Publications: Show only first publication on mobile */
		.recent-publications .pub-preview:nth-child(n+2) {
			display: none;
		}

		/* News: Show only first news item on mobile */
		.news-list > *:nth-child(n+2) {
			display: none;
		}

		.stats-grid {
			grid-template-columns: repeat(2, 1fr);
		}

		.stat-number {
			font-size: var(--text-2xl);
		}

		.stat-label {
			font-size: 0.75rem;
		}

		.featured-projects {
			grid-template-columns: 1fr;
		}
	}
</style>

<script>
	// Animated stat counters
	function animateCounter(element: HTMLElement, target: number, suffix: string = '') {
		const duration = 2000; // 2 seconds
		const steps = 60;
		const increment = target / steps;
		let current = 0;
		const timer = setInterval(() => {
			current += increment;
			if (current >= target) {
				element.textContent = target.toLocaleString() + suffix;
				clearInterval(timer);
			} else {
				element.textContent = Math.floor(current).toLocaleString() + suffix;
			}
		}, duration / steps);
	}

	// Initialize animations (works with View Transitions)
	function initAnimations() {
		// Reset stat counters to 0
		const statNumbers = document.querySelectorAll('.stat-number[data-target]');
		statNumbers.forEach((el) => {
			el.textContent = '0';
		});

		// Trigger counters when stats section is visible
		const statsSection = document.querySelector('.stats-section');
		if (statsSection) {
			const observer = new IntersectionObserver((entries) => {
				entries.forEach(entry => {
					if (entry.isIntersecting) {
						const statNumbers = document.querySelectorAll('.stat-number[data-target]');
						statNumbers.forEach((el) => {
							const target = parseInt(el.getAttribute('data-target') || '0');
							const suffix = (target >= 16 || target >= 10000) ? '+' : '';
							animateCounter(el as HTMLElement, target, suffix);
						});
						observer.unobserve(entry.target);
					}
				});
			}, { threshold: 0.5 });

			observer.observe(statsSection);
		}
	}

	// Run on initial load and when navigating with View Transitions
	document.addEventListener('astro:page-load', initAnimations);
	initAnimations();
</script>
