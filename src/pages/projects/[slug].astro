---
import { getCollection, render } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

// Generate static paths for all projects
export async function getStaticPaths() {
	const projects = await getCollection('projects');
	return projects.map(project => ({
		params: { slug: project.id },
		props: { entry: project }
	}));
}

const { entry } = Astro.props;
const { Content } = await render(entry);

// Status label mapping
const statusLabel = entry.data.status === 'ongoing' ? 'Ongoing' :
                    entry.data.status === 'released' ? 'Released' : 'Complete';
---

<BaseLayout title={entry.data.title} description={entry.data.description}>
	<div class="stack gap-20 lg:gap-48">
		<div class="wrapper stack gap-8 lg:gap-20">
			<header class="project-header">
				<div class="breadcrumb">
					<a href="/projects/">‚Üê Back to Projects</a>
				</div>

				<div class="project-status-header">
					<span class={`project-status ${entry.data.status}`}>{statusLabel}</span>
				</div>

				<h1 class="project-title">{entry.data.title}</h1>
				<p class="project-subtitle">{entry.data.description}</p>
			</header>

			<main class="project-content">
				<div class="meta-section">
					<div class="project-info">
						<div class="info-item">
							<strong>Timeline:</strong> {entry.data.meta}
						</div>
						{entry.data.publishedDate && (
							<div class="info-item">
								<strong>Published:</strong> {new Date(entry.data.publishedDate).toLocaleDateString('en-US', {
									year: 'numeric',
									month: 'long',
									day: 'numeric'
								})}
							</div>
						)}
					</div>

					{entry.data.tags && entry.data.tags.length > 0 && (
						<div class="tags">
							{entry.data.tags.map(tag => (
								<span class="tag">{tag}</span>
							))}
						</div>
					)}

					{entry.data.links && entry.data.links.length > 0 && (
						<div class="project-links">
							{entry.data.links.map(link => (
								<a href={link.href} class="project-link-btn" target="_blank" rel="noopener noreferrer">
									{link.label}
								</a>
							))}
						</div>
					)}
				</div>

				<div class="content-section">
					<Content />
				</div>
			</main>
		</div>
	</div>
</BaseLayout>

<style>
	.project-status-header {
		margin-bottom: 1rem;
	}

	.project-status {
		display: inline-block;
		padding: 0.375rem 1rem;
		border-radius: 0.375rem;
		font-size: var(--text-sm);
		font-weight: 600;
	}

	.project-status.ongoing {
		background: var(--accent-regular);
		color: var(--accent-text-over);
	}

	.project-status.complete {
		background: var(--gray-600);
		color: var(--gray-999);
	}

	.project-status.released {
		background: var(--accent-dark);
		color: var(--gray-999);
	}
</style>

<script>
	// Smart back button: go to referring page if from same site, otherwise fallback to projects list
	const backLink = document.querySelector('.breadcrumb a');
	if (backLink) {
		backLink.addEventListener('click', (e) => {
			const referrer = document.referrer;
			const currentDomain = window.location.origin;

			// If user came from somewhere on our site, go back in history
			if (referrer && referrer.startsWith(currentDomain)) {
				e.preventDefault();
				window.history.back();
			}
			// Otherwise, let the default href handle it (goes to /projects/)
		});
	}
</script>
