---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';

// Get all news, filter drafts, and sort by date (newest first)
const allNews = (await getCollection('news'))
	.filter(n => !n.data.draft)
	.sort((a, b) => b.data.publishedDate.valueOf() - a.data.publishedDate.valueOf());

// Group news by year
const newsByYear = allNews.reduce((acc, news) => {
	const year = news.data.publishedDate.getFullYear();
	if (!acc[year]) {
		acc[year] = [];
	}
	acc[year].push(news);
	return acc;
}, {} as Record<number, typeof allNews>);

// Sort years descending
const years = Object.keys(newsByYear).map(Number).sort((a, b) => b - a);
---

<BaseLayout title="News & Updates" description="Academic news, talks, and research updates">
	<div class="stack gap-20 lg:gap-48">
		<div class="wrapper stack gap-8 lg:gap-20">
			<header class="page-header">
				<h1 class="page-title">News & Updates</h1>
				<p class="page-subtitle">Recent activities, talks, and academic milestones</p>
			</header>

			<main class="news-content stack gap-10 lg:gap-15">
				{years.map(year => (
					<section class="news-section">
						<h2 class="section-title">{year}</h2>
						<div class="news-timeline stack gap-4">
							{newsByYear[year].map(news => {
								const hasContent = news.body && news.body.trim().length > 0;

								return hasContent ? (
									<a href={`/news/${news.id}/`} class="news-card-link">
										<article class="news-card">
											<span class="news-date">{news.data.date}</span>
											<h3 class="news-title">{news.data.title}</h3>
											<p class="news-description">
												{news.data.description}
											</p>
										</article>
									</a>
								) : (
									<article class="news-card">
										<span class="news-date">{news.data.date}</span>
										<h3 class="news-title">{news.data.title}</h3>
										<p class="news-description">
											{news.data.description}
										</p>
									</article>
								);
							})}
						</div>
					</section>
				))}
			</main>
		</div>
	</div>
</BaseLayout>

<style>
	.page-header {
		padding-block: 2.5rem;
		text-align: center;
		max-width: 50rem;
		margin-inline: auto;
	}

	.page-title {
		font-size: var(--text-4xl);
		color: var(--gray-0);
		margin: 0 0 0.5rem;
	}

	.page-subtitle {
		font-size: var(--text-lg);
		color: var(--gray-300);
		margin: 0;
	}

	.news-content {
		max-width: 60rem;
		margin-inline: auto;
	}

	.news-section {
		padding-block: 1rem;
	}

	.section-title {
		font-size: var(--text-2xl);
		color: var(--gray-0);
		margin-bottom: 1.5rem;
		padding-bottom: 0.5rem;
		border-bottom: 2px solid var(--accent-regular);
	}

	.news-timeline {
		padding-left: 0.5rem;
	}

	.news-card-link {
		text-decoration: none;
		display: block;
	}

	.news-card {
		padding: 1.5rem;
		background: var(--gray-999);
		border-radius: 0.5rem;
		border-left: 3px solid var(--accent-light);
		box-shadow: var(--shadow-sm);
		transition: all var(--theme-transition);
	}

	.news-card-link .news-card {
		cursor: pointer;
	}

	.news-card:hover {
		transform: translateY(-2px);
		box-shadow: var(--shadow-md);
		border-left-width: 4px;
	}

	.news-date {
		font-size: var(--text-sm);
		color: var(--accent-regular);
		font-weight: 600;
		font-family: var(--font-brand);
		display: block;
		margin-bottom: 0.5rem;
	}

	.news-title {
		font-size: var(--text-lg);
		color: var(--gray-0);
		margin: 0 0 0.5rem;
		line-height: 1.3;
	}

	.news-description {
		font-size: var(--text-base);
		color: var(--gray-300);
		line-height: 1.6;
		margin: 0;
	}

	@media (max-width: 50em) {
		.page-title {
			font-size: var(--text-3xl);
		}

		.page-subtitle {
			font-size: var(--text-base);
		}

		.section-title {
			font-size: var(--text-xl);
		}

		.news-card {
			padding: 1.25rem;
		}

		.news-title {
			font-size: var(--text-md);
		}

		.news-description {
			font-size: var(--text-sm);
		}
	}
</style>
